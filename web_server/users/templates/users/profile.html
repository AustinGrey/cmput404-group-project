<!-- profile.png reference: https://images.app.goo.gl/YSQk29RxAckDdLsY8 -->
{% extends "navigation.html" %}
{% block navigation_content %}
{% load static %}
<link rel="stylesheet" href="{% static '/users/css/style.css' %}" xmlns:v-bind="http://www.w3.org/1999/xhtml">


<div id="app">
    <div class="container profile-image">
        <div>
            <img src="{% static '/users/images/profile.png' %}" height="100%" width="100%">
        </div>

    </div>
    <div class="container profile-info">
        <div class="container">
            <div class="container profile-info-head">
                <h1 style="text-align: center"> {{user.first_name}}, Welcome to Mandala </h1>
            </div>

            <user-info
                    v-bind:user="user"
            ></user-info>
            </div>


        <div class="card">
             <div class="card-header">
                 Friends Requests
             </div>
             <div class="card-body">
                <ul class="list-group">
                    <request-list
                        v-for="(sender, index) in request_senders"
                        v-bind:sender="sender"
                        v-bind:index="index"
                    >
                    </request-list>
                </ul>
             </div>
        </div>


         <div class="card">
             <div class="card-header">
                 My Friends
             </div>
             <div class="card-body">
                 <ul class="list-group">
                     <friend-list
                       v-for="(friend, index) in friends"
                       v-bind:friend="friend"
                       v-bind:index="index"
                     >
                    </friend-list>
                 </ul>
             </div>

         </div>
    </div>





</div>
<template id="list-friend">
    <div v-if="!friend.isDeleted">
        <li class="list-group-item">
            <div class="form-inline">
                <a v-bind:href="'{% url 'profile' %}' + friend.uid">[[friend.displayName]]</a>
                <button class="btn btn-primary" @click="app.unfriend(friend.id, '{{ user.id }}', index)">Delete</button>

            </div>
        </li>
    </div>
</template>


<template id="list-item">
    <div v-if="!sender.isDeleted">
        <li class="list-group-item">
            <div class="form-inline">
                <a v-bind:href="'{% url 'profile' %}' + sender.uid">[[sender.firstName + ' ' + sender.lastName]]</a>
                <button class="btn btn-primary" @click="app.accept(sender.id, '{{ user.id }}', index)">Accept</button>
                <button class="btn btn-warning" @click="app.deny(sender.id, '{{ user.id }}', index)">Deny</button>
            </div>
        </li>
    </div>
</template>


<template id="user-info">
    <div class="container profile-info-body">
        <div class="form-group">
            <label for="first_name">Firstname: </label>
            <input class="form-control" id="first_name" type="text" name="first_name"
                v-bind:value="user.firstName">
            <label for="last_name">Lastname: </label>
            <input class="form-control" id="last_name" type="text" name="last_name"
                v-bind:value="user.lastName">
            <label for="display_name">Displayname: </label>
            <input class="form-control" id="display_name" type="text" name="display_name"
                v-bind:value=" user.displayName">
            <label for="email">Email: </label>
            <input class="form-control" id="email" type="text" name="email"
                v-bind:value="user.email">
            <label for="bio">Bio: </label>
            <input class="form-control" id="bio" type="text" name="bio" v-bind:value="user.bio">
            <label for="github">Github: </label>
            <input class="form-control" id="github" type="text" name="github"
                v-bind:value=" user.github">
        </div>
        {% if author_id == user.id %}
            <button class="btn btn-primary ">Edit</button>
        {% endif %}
    </div>
</template>
<script>
    Vue.component('request-list', {
        delimiters: ['[[', ']]'],
        props: ['sender', 'index'],
        template: '#list-item'
    });

    Vue.component('friend-list', {
        delimiters: ['[[', ']]'],
        props: ['friend', 'index'],
        template: '#list-friend'
    });

    Vue.component('user-info', {
        delimiters: ['[[', ']]'],
        props: ['user'],
        template: '#user-info'
    });

    var app = new Vue({
        el: '#app',
        data() {
            return {
                request_senders: [],
                user: {},
                friends: []
            }
        },
        methods: {
            get_user(id){
                let url = '/author/'+ id;
                window.axios.get(url).then((response)=>{
                    this.user = response.data;
                    this.friends = response.data['friends'];
                    console.log(this.friends);
                })
            },

            get_request(url) {
                window.axios.get(url).then((response)=>{
                    let data = response.data;
                    let from_ids = data['request'];

                    for (var uid of from_ids){
                        let idlist = uid.split('/');

                        let from_id = idlist[idlist.length - 1];
                        window.axios.get('/author/'+ from_id).then((response) =>{
                            //let username = response.data['firstName'] +' '+ response.data['lastName'];
                            response.data['uid'] = idlist[idlist.length - 1];
                            response.data['isDeleted'] = false;
                            this.request_senders.push(response.data);
                        })
                    }
                });
            },
            accept: function (sender_id, user_id, index) {
                window.axios.post("/friendrequest/handle", {
                    // Author id is from_id (Other's id)
                    "author": {
                        "id": sender_id
                    },
                    // Friend id is to_id (Your id)
                    "friend": {
                        "id": "http://127.0.0.1:8000/author/" + user_id
                    }
                }).then((response) => {
                    if(response.status === 200){
                        alert(response.data);
                        this.request_senders[index]['isDeleted'] = true;
                    }
                })
            },
            deny: function (sender_id, user_id, index) {
                window.axios.delete("/friendrequest/handle", {
                    data:{
                        "author": {
                            "id": sender_id
                        },
                        // Friend id is to_id (Your id)
                        "friend": {
                            "id": "http://127.0.0.1:8000/author/" + user_id
                        }
                    }

                    }).then((response) => {
                    if (response.status === 200) {
                        alert(response.data);
                        this.request_senders[index]['isDeleted'] = true;
                    }
                })
            },
            unfriend: function(friend_id, user_id,index){
                window.axios.post("/author/unfriend", {
                    'author_id':user_id,
                    'friend_id':friend_id
                }).then((response) => {
                    if(response.status === 200){
                        alert(response.data);
                        this.friends[index]['isDeleted'] = true;
                    }
                });
            },
        },

        created() {
            this.get_user("{{user.id}}");
            this.get_request('/friendrequest/{{user.id}}');
        }
    });

</script>


{% endblock %}
